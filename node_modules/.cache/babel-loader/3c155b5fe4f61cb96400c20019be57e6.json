{"ast":null,"code":"function _toConsumableArray(arr) {\n  return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread();\n}\n\nfunction _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\n\nfunction _iterableToArray(iter) {\n  if (typeof Symbol !== \"undefined\" && iter[Symbol.iterator] != null || iter[\"@@iterator\"] != null) return Array.from(iter);\n}\n\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) return _arrayLikeToArray(arr);\n}\n\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  var _i = arr && (typeof Symbol !== \"undefined\" && arr[Symbol.iterator] || arr[\"@@iterator\"]);\n\n  if (_i == null) return;\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n\n  var _s, _e;\n\n  try {\n    for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) {\n  var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"];\n\n  if (!it) {\n    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n      if (it) o = it;\n      var i = 0;\n\n      var F = function F() {};\n\n      return {\n        s: F,\n        n: function n() {\n          if (i >= o.length) return {\n            done: true\n          };\n          return {\n            done: false,\n            value: o[i++]\n          };\n        },\n        e: function e(_e2) {\n          throw _e2;\n        },\n        f: F\n      };\n    }\n\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n\n  var normalCompletion = true,\n      didErr = false,\n      err;\n  return {\n    s: function s() {\n      it = it.call(o);\n    },\n    n: function n() {\n      var step = it.next();\n      normalCompletion = step.done;\n      return step;\n    },\n    e: function e(_e3) {\n      didErr = true;\n      err = _e3;\n    },\n    f: function f() {\n      try {\n        if (!normalCompletion && it.return != null) it.return();\n      } finally {\n        if (didErr) throw err;\n      }\n    }\n  };\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n/**\n * @license\n * Copyright (c) 2021 Handsoncode. All rights reserved.\n */\n\n\nimport { CellError, movedSimpleCellAddress } from '../Cell';\nimport { AddRowsTransformer } from '../dependencyTransformers/AddRowsTransformer';\nimport { RemoveRowsTransformer } from '../dependencyTransformers/RemoveRowsTransformer';\nimport { forceNormalizeString } from '../interpreter/ArithmeticHelper';\nimport { SimpleRangeValue } from '../interpreter/SimpleRangeValue';\nimport { Matrix } from '../Matrix';\nimport { StatType } from '../statistics';\nimport { ColumnBinarySearch } from './ColumnBinarySearch';\nexport var ColumnIndex = /*#__PURE__*/function () {\n  function ColumnIndex(dependencyGraph, config, stats) {\n    _classCallCheck(this, ColumnIndex);\n\n    this.dependencyGraph = dependencyGraph;\n    this.config = config;\n    this.stats = stats;\n    this.index = new Map();\n    this.transformingService = this.dependencyGraph.lazilyTransformingAstService;\n    this.binarySearchStrategy = new ColumnBinarySearch(dependencyGraph, config);\n  }\n\n  _createClass(ColumnIndex, [{\n    key: \"add\",\n    value: function add(value, address) {\n      if (value instanceof Matrix) {\n        var _iterator = _createForOfIteratorHelper(value.generateValues(address)),\n            _step;\n\n        try {\n          for (_iterator.s(); !(_step = _iterator.n()).done;) {\n            var _step$value = _slicedToArray(_step.value, 2),\n                matrixValue = _step$value[0],\n                cellAddress = _step$value[1];\n\n            this.addSingleCellValue(matrixValue, cellAddress);\n          }\n        } catch (err) {\n          _iterator.e(err);\n        } finally {\n          _iterator.f();\n        }\n      } else if (!(value instanceof CellError || value instanceof SimpleRangeValue)) {\n        this.addSingleCellValue(value, address);\n      }\n    }\n  }, {\n    key: \"remove\",\n    value: function remove(value, address) {\n      if (!value) {\n        return;\n      }\n\n      if (value instanceof Matrix) {\n        var _iterator2 = _createForOfIteratorHelper(value.generateValues(address)),\n            _step2;\n\n        try {\n          for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n            var _step2$value = _slicedToArray(_step2.value, 2),\n                matrixValue = _step2$value[0],\n                cellAddress = _step2$value[1];\n\n            this.removeSingleValue(matrixValue, cellAddress);\n          }\n        } catch (err) {\n          _iterator2.e(err);\n        } finally {\n          _iterator2.f();\n        }\n      } else {\n        this.removeSingleValue(value, address);\n      }\n    }\n  }, {\n    key: \"change\",\n    value: function change(oldValue, newValue, address) {\n      if (oldValue === newValue) {\n        return;\n      }\n\n      this.remove(oldValue, address);\n      this.add(newValue, address);\n    }\n  }, {\n    key: \"moveValues\",\n    value: function moveValues(sourceRange, toRight, toBottom, toSheet) {\n      var _iterator3 = _createForOfIteratorHelper(sourceRange),\n          _step3;\n\n      try {\n        for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n          var _step3$value = _slicedToArray(_step3.value, 2),\n              value = _step3$value[0],\n              address = _step3$value[1];\n\n          var targetAddress = movedSimpleCellAddress(address, toSheet, toRight, toBottom);\n          this.remove(value, address);\n          this.add(value, targetAddress);\n        }\n      } catch (err) {\n        _iterator3.e(err);\n      } finally {\n        _iterator3.f();\n      }\n    }\n  }, {\n    key: \"removeValues\",\n    value: function removeValues(range) {\n      var _iterator4 = _createForOfIteratorHelper(range),\n          _step4;\n\n      try {\n        for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n          var _step4$value = _slicedToArray(_step4.value, 2),\n              value = _step4$value[0],\n              address = _step4$value[1];\n\n          this.remove(value, address);\n        }\n      } catch (err) {\n        _iterator4.e(err);\n      } finally {\n        _iterator4.f();\n      }\n    }\n  }, {\n    key: \"find\",\n    value: function find(key, range, sorted) {\n      this.ensureRecentData(range.sheet, range.start.col, key);\n      var columnMap = this.getColumnMap(range.sheet, range.start.col);\n\n      if (!columnMap) {\n        return -1;\n      }\n\n      if (typeof key === 'string') {\n        key = forceNormalizeString(key);\n      }\n\n      var valueIndex = columnMap.get(key);\n\n      if (!valueIndex) {\n        return this.binarySearchStrategy.find(key, range, sorted);\n      }\n\n      var index = upperBound(valueIndex.index, range.start.row);\n      var rowNumber = valueIndex.index[index];\n      return rowNumber <= range.end.row ? rowNumber : this.binarySearchStrategy.find(key, range, sorted);\n    }\n  }, {\n    key: \"advancedFind\",\n    value: function advancedFind(keyMatcher, range) {\n      return this.binarySearchStrategy.advancedFind(keyMatcher, range);\n    }\n  }, {\n    key: \"addColumns\",\n    value: function addColumns(columnsSpan) {\n      var sheetIndex = this.index.get(columnsSpan.sheet);\n\n      if (!sheetIndex) {\n        return;\n      }\n\n      sheetIndex.splice.apply(sheetIndex, [columnsSpan.columnStart, 0].concat(_toConsumableArray(Array(columnsSpan.numberOfColumns))));\n    }\n  }, {\n    key: \"removeColumns\",\n    value: function removeColumns(columnsSpan) {\n      var sheetIndex = this.index.get(columnsSpan.sheet);\n\n      if (!sheetIndex) {\n        return;\n      }\n\n      sheetIndex.splice(columnsSpan.columnStart, columnsSpan.numberOfColumns);\n    }\n  }, {\n    key: \"removeSheet\",\n    value: function removeSheet(sheetId) {\n      this.index.delete(sheetId);\n    }\n  }, {\n    key: \"getColumnMap\",\n    value: function getColumnMap(sheet, col) {\n      if (!this.index.has(sheet)) {\n        this.index.set(sheet, []);\n      }\n\n      var sheetMap = this.index.get(sheet); // eslint-disable-line @typescript-eslint/no-non-null-assertion\n\n      var columnMap = sheetMap[col];\n\n      if (!columnMap) {\n        columnMap = new Map();\n        sheetMap[col] = columnMap;\n      }\n\n      return columnMap;\n    }\n  }, {\n    key: \"getValueIndex\",\n    value: function getValueIndex(sheet, col, value) {\n      var columnMap = this.getColumnMap(sheet, col);\n      var index = this.getColumnMap(sheet, col).get(value);\n\n      if (!index) {\n        index = {\n          version: this.transformingService.version(),\n          index: []\n        };\n        columnMap.set(value, index);\n      }\n\n      return index;\n    }\n  }, {\n    key: \"ensureRecentData\",\n    value: function ensureRecentData(sheet, col, value) {\n      var valueIndex = this.getValueIndex(sheet, col, value);\n      var actualVersion = this.transformingService.version();\n\n      if (valueIndex.version === actualVersion) {\n        return;\n      }\n\n      var relevantTransformations = this.transformingService.getTransformationsFrom(valueIndex.version, function (transformation) {\n        return transformation.sheet === sheet && (transformation instanceof AddRowsTransformer || transformation instanceof RemoveRowsTransformer);\n      });\n\n      var _iterator5 = _createForOfIteratorHelper(relevantTransformations),\n          _step5;\n\n      try {\n        for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {\n          var transformation = _step5.value;\n\n          if (transformation instanceof AddRowsTransformer) {\n            this.addRows(col, transformation.rowsSpan, value);\n          } else if (transformation instanceof RemoveRowsTransformer) {\n            this.removeRows(col, transformation.rowsSpan, value);\n          }\n        }\n      } catch (err) {\n        _iterator5.e(err);\n      } finally {\n        _iterator5.f();\n      }\n\n      valueIndex.version = actualVersion;\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.index.clear();\n    }\n  }, {\n    key: \"addSingleCellValue\",\n    value: function addSingleCellValue(value, address) {\n      var _this = this;\n\n      this.stats.measure(StatType.BUILD_COLUMN_INDEX, function () {\n        _this.ensureRecentData(address.sheet, address.col, value);\n\n        if (typeof value === 'string') {\n          value = forceNormalizeString(value);\n        }\n\n        var valueIndex = _this.getValueIndex(address.sheet, address.col, value);\n\n        _this.addValue(valueIndex, address.row);\n      });\n    }\n  }, {\n    key: \"removeSingleValue\",\n    value: function removeSingleValue(value, address) {\n      var _this2 = this;\n\n      this.stats.measure(StatType.BUILD_COLUMN_INDEX, function () {\n        _this2.ensureRecentData(address.sheet, address.col, value);\n\n        var columnMap = _this2.getColumnMap(address.sheet, address.col);\n\n        if (typeof value === 'string') {\n          value = forceNormalizeString(value);\n        }\n\n        var valueIndex = columnMap.get(value);\n\n        if (!valueIndex) {\n          return;\n        }\n\n        var index = upperBound(valueIndex.index, address.row);\n        valueIndex.index.splice(index, 1);\n\n        if (valueIndex.index.length === 0) {\n          columnMap.delete(value);\n        }\n\n        if (columnMap.size === 0) {\n          delete _this2.index.get(address.sheet)[address.col]; // eslint-disable-line @typescript-eslint/no-non-null-assertion\n        }\n      });\n    }\n  }, {\n    key: \"addRows\",\n    value: function addRows(col, rowsSpan, value) {\n      var valueIndex = this.getValueIndex(rowsSpan.sheet, col, value);\n      this.shiftRows(valueIndex, rowsSpan.rowStart, rowsSpan.numberOfRows);\n    }\n  }, {\n    key: \"removeRows\",\n    value: function removeRows(col, rowsSpan, value) {\n      var valueIndex = this.getValueIndex(rowsSpan.sheet, col, value);\n      this.removeRowsFromValues(valueIndex, rowsSpan);\n      this.shiftRows(valueIndex, rowsSpan.rowEnd + 1, -rowsSpan.numberOfRows);\n    }\n  }, {\n    key: \"addValue\",\n    value: function addValue(valueIndex, rowNumber) {\n      var rowIndex = lowerBound(valueIndex.index, rowNumber);\n      var value = valueIndex.index[rowIndex];\n\n      if (value === rowNumber) {\n        /* do not add same row twice */\n        return;\n      }\n\n      if (rowIndex === valueIndex.index.length - 1) {\n        valueIndex.index.push(rowNumber);\n      } else {\n        valueIndex.index.splice(rowIndex + 1, 0, rowNumber);\n      }\n    }\n  }, {\n    key: \"removeRowsFromValues\",\n    value: function removeRowsFromValues(rows, rowsSpan) {\n      var start = upperBound(rows.index, rowsSpan.rowStart);\n      var end = lowerBound(rows.index, rowsSpan.rowEnd);\n\n      if (rows.index[start] <= rowsSpan.rowEnd) {\n        rows.index.splice(start, end - start + 1);\n      }\n    }\n  }, {\n    key: \"shiftRows\",\n    value: function shiftRows(rows, afterRow, numberOfRows) {\n      var index = upperBound(rows.index, afterRow);\n\n      for (var i = index; i < rows.index.length; ++i) {\n        rows.index[i] += numberOfRows;\n      }\n    }\n  }]);\n\n  return ColumnIndex;\n}();\n/*\n* If key exists returns index of key\n* Otherwise returns index of smallest element greater than key\n* assuming sorted array and no repetitions\n* */\n\nexport function upperBound(values, key) {\n  var start = 0;\n  var end = values.length - 1;\n\n  while (start <= end) {\n    var center = Math.floor((start + end) / 2);\n\n    if (key > values[center]) {\n      start = center + 1;\n    } else if (key < values[center]) {\n      end = center - 1;\n    } else {\n      return center;\n    }\n  }\n\n  return start;\n}\n/*\n* If key exists returns index of key\n* Otherwise returns index of greatest element smaller than key\n* assuming sorted array and no repetitions\n* */\n\nexport function lowerBound(values, key) {\n  var start = 0;\n  var end = values.length - 1;\n\n  while (start <= end) {\n    var center = Math.floor((start + end) / 2);\n\n    if (key > values[center]) {\n      start = center + 1;\n    } else if (key < values[center]) {\n      end = center - 1;\n    } else {\n      return center;\n    }\n  }\n\n  return end;\n}","map":{"version":3,"sources":["/Users/mingjie.wang/Documents/Uber/MandA/demo-project/node_modules/hyperformula/es/Lookup/ColumnIndex.js"],"names":["_toConsumableArray","arr","_arrayWithoutHoles","_iterableToArray","_unsupportedIterableToArray","_nonIterableSpread","TypeError","iter","Symbol","iterator","Array","from","isArray","_arrayLikeToArray","_slicedToArray","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","_i","_arr","_n","_d","_s","_e","call","next","done","push","value","length","err","_createForOfIteratorHelper","o","allowArrayLike","it","F","s","n","e","_e2","f","normalCompletion","didErr","step","_e3","return","minLen","Object","prototype","toString","slice","constructor","name","test","len","arr2","_classCallCheck","instance","Constructor","_defineProperties","target","props","descriptor","enumerable","configurable","writable","defineProperty","key","_createClass","protoProps","staticProps","CellError","movedSimpleCellAddress","AddRowsTransformer","RemoveRowsTransformer","forceNormalizeString","SimpleRangeValue","Matrix","StatType","ColumnBinarySearch","ColumnIndex","dependencyGraph","config","stats","index","Map","transformingService","lazilyTransformingAstService","binarySearchStrategy","add","address","_iterator","generateValues","_step","_step$value","matrixValue","cellAddress","addSingleCellValue","remove","_iterator2","_step2","_step2$value","removeSingleValue","change","oldValue","newValue","moveValues","sourceRange","toRight","toBottom","toSheet","_iterator3","_step3","_step3$value","targetAddress","removeValues","range","_iterator4","_step4","_step4$value","find","sorted","ensureRecentData","sheet","start","col","columnMap","getColumnMap","valueIndex","get","upperBound","row","rowNumber","end","advancedFind","keyMatcher","addColumns","columnsSpan","sheetIndex","splice","apply","columnStart","concat","numberOfColumns","removeColumns","removeSheet","sheetId","delete","has","set","sheetMap","getValueIndex","version","actualVersion","relevantTransformations","getTransformationsFrom","transformation","_iterator5","_step5","addRows","rowsSpan","removeRows","destroy","clear","_this","measure","BUILD_COLUMN_INDEX","addValue","_this2","size","shiftRows","rowStart","numberOfRows","removeRowsFromValues","rowEnd","rowIndex","lowerBound","rows","afterRow","values","center","Math","floor"],"mappings":"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","sourcesContent":["function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }\n\nfunction _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); }\n\nfunction _iterableToArray(iter) { if (typeof Symbol !== \"undefined\" && iter[Symbol.iterator] != null || iter[\"@@iterator\"] != null) return Array.from(iter); }\n\nfunction _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); }\n\nfunction _iterableToArrayLimit(arr, i) { var _i = arr && (typeof Symbol !== \"undefined\" && arr[Symbol.iterator] || arr[\"@@iterator\"]); if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"]; if (!it) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e2) { throw _e2; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e3) { didErr = true; err = _e3; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport \"core-js/modules/es.array.iterator.js\";\nimport \"core-js/modules/es.map.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.string.iterator.js\";\nimport \"core-js/modules/web.dom-collections.iterator.js\";\nimport \"core-js/modules/es.array.find.js\";\nimport \"core-js/modules/es.array.splice.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.array.slice.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.array.from.js\";\nimport \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.symbol.iterator.js\";\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\n/**\n * @license\n * Copyright (c) 2021 Handsoncode. All rights reserved.\n */\nimport { CellError, movedSimpleCellAddress } from '../Cell';\nimport { AddRowsTransformer } from '../dependencyTransformers/AddRowsTransformer';\nimport { RemoveRowsTransformer } from '../dependencyTransformers/RemoveRowsTransformer';\nimport { forceNormalizeString } from '../interpreter/ArithmeticHelper';\nimport { SimpleRangeValue } from '../interpreter/SimpleRangeValue';\nimport { Matrix } from '../Matrix';\nimport { StatType } from '../statistics';\nimport { ColumnBinarySearch } from './ColumnBinarySearch';\nexport var ColumnIndex = /*#__PURE__*/function () {\n  function ColumnIndex(dependencyGraph, config, stats) {\n    _classCallCheck(this, ColumnIndex);\n\n    this.dependencyGraph = dependencyGraph;\n    this.config = config;\n    this.stats = stats;\n    this.index = new Map();\n    this.transformingService = this.dependencyGraph.lazilyTransformingAstService;\n    this.binarySearchStrategy = new ColumnBinarySearch(dependencyGraph, config);\n  }\n\n  _createClass(ColumnIndex, [{\n    key: \"add\",\n    value: function add(value, address) {\n      if (value instanceof Matrix) {\n        var _iterator = _createForOfIteratorHelper(value.generateValues(address)),\n            _step;\n\n        try {\n          for (_iterator.s(); !(_step = _iterator.n()).done;) {\n            var _step$value = _slicedToArray(_step.value, 2),\n                matrixValue = _step$value[0],\n                cellAddress = _step$value[1];\n\n            this.addSingleCellValue(matrixValue, cellAddress);\n          }\n        } catch (err) {\n          _iterator.e(err);\n        } finally {\n          _iterator.f();\n        }\n      } else if (!(value instanceof CellError || value instanceof SimpleRangeValue)) {\n        this.addSingleCellValue(value, address);\n      }\n    }\n  }, {\n    key: \"remove\",\n    value: function remove(value, address) {\n      if (!value) {\n        return;\n      }\n\n      if (value instanceof Matrix) {\n        var _iterator2 = _createForOfIteratorHelper(value.generateValues(address)),\n            _step2;\n\n        try {\n          for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n            var _step2$value = _slicedToArray(_step2.value, 2),\n                matrixValue = _step2$value[0],\n                cellAddress = _step2$value[1];\n\n            this.removeSingleValue(matrixValue, cellAddress);\n          }\n        } catch (err) {\n          _iterator2.e(err);\n        } finally {\n          _iterator2.f();\n        }\n      } else {\n        this.removeSingleValue(value, address);\n      }\n    }\n  }, {\n    key: \"change\",\n    value: function change(oldValue, newValue, address) {\n      if (oldValue === newValue) {\n        return;\n      }\n\n      this.remove(oldValue, address);\n      this.add(newValue, address);\n    }\n  }, {\n    key: \"moveValues\",\n    value: function moveValues(sourceRange, toRight, toBottom, toSheet) {\n      var _iterator3 = _createForOfIteratorHelper(sourceRange),\n          _step3;\n\n      try {\n        for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n          var _step3$value = _slicedToArray(_step3.value, 2),\n              value = _step3$value[0],\n              address = _step3$value[1];\n\n          var targetAddress = movedSimpleCellAddress(address, toSheet, toRight, toBottom);\n          this.remove(value, address);\n          this.add(value, targetAddress);\n        }\n      } catch (err) {\n        _iterator3.e(err);\n      } finally {\n        _iterator3.f();\n      }\n    }\n  }, {\n    key: \"removeValues\",\n    value: function removeValues(range) {\n      var _iterator4 = _createForOfIteratorHelper(range),\n          _step4;\n\n      try {\n        for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n          var _step4$value = _slicedToArray(_step4.value, 2),\n              value = _step4$value[0],\n              address = _step4$value[1];\n\n          this.remove(value, address);\n        }\n      } catch (err) {\n        _iterator4.e(err);\n      } finally {\n        _iterator4.f();\n      }\n    }\n  }, {\n    key: \"find\",\n    value: function find(key, range, sorted) {\n      this.ensureRecentData(range.sheet, range.start.col, key);\n      var columnMap = this.getColumnMap(range.sheet, range.start.col);\n\n      if (!columnMap) {\n        return -1;\n      }\n\n      if (typeof key === 'string') {\n        key = forceNormalizeString(key);\n      }\n\n      var valueIndex = columnMap.get(key);\n\n      if (!valueIndex) {\n        return this.binarySearchStrategy.find(key, range, sorted);\n      }\n\n      var index = upperBound(valueIndex.index, range.start.row);\n      var rowNumber = valueIndex.index[index];\n      return rowNumber <= range.end.row ? rowNumber : this.binarySearchStrategy.find(key, range, sorted);\n    }\n  }, {\n    key: \"advancedFind\",\n    value: function advancedFind(keyMatcher, range) {\n      return this.binarySearchStrategy.advancedFind(keyMatcher, range);\n    }\n  }, {\n    key: \"addColumns\",\n    value: function addColumns(columnsSpan) {\n      var sheetIndex = this.index.get(columnsSpan.sheet);\n\n      if (!sheetIndex) {\n        return;\n      }\n\n      sheetIndex.splice.apply(sheetIndex, [columnsSpan.columnStart, 0].concat(_toConsumableArray(Array(columnsSpan.numberOfColumns))));\n    }\n  }, {\n    key: \"removeColumns\",\n    value: function removeColumns(columnsSpan) {\n      var sheetIndex = this.index.get(columnsSpan.sheet);\n\n      if (!sheetIndex) {\n        return;\n      }\n\n      sheetIndex.splice(columnsSpan.columnStart, columnsSpan.numberOfColumns);\n    }\n  }, {\n    key: \"removeSheet\",\n    value: function removeSheet(sheetId) {\n      this.index.delete(sheetId);\n    }\n  }, {\n    key: \"getColumnMap\",\n    value: function getColumnMap(sheet, col) {\n      if (!this.index.has(sheet)) {\n        this.index.set(sheet, []);\n      }\n\n      var sheetMap = this.index.get(sheet); // eslint-disable-line @typescript-eslint/no-non-null-assertion\n\n      var columnMap = sheetMap[col];\n\n      if (!columnMap) {\n        columnMap = new Map();\n        sheetMap[col] = columnMap;\n      }\n\n      return columnMap;\n    }\n  }, {\n    key: \"getValueIndex\",\n    value: function getValueIndex(sheet, col, value) {\n      var columnMap = this.getColumnMap(sheet, col);\n      var index = this.getColumnMap(sheet, col).get(value);\n\n      if (!index) {\n        index = {\n          version: this.transformingService.version(),\n          index: []\n        };\n        columnMap.set(value, index);\n      }\n\n      return index;\n    }\n  }, {\n    key: \"ensureRecentData\",\n    value: function ensureRecentData(sheet, col, value) {\n      var valueIndex = this.getValueIndex(sheet, col, value);\n      var actualVersion = this.transformingService.version();\n\n      if (valueIndex.version === actualVersion) {\n        return;\n      }\n\n      var relevantTransformations = this.transformingService.getTransformationsFrom(valueIndex.version, function (transformation) {\n        return transformation.sheet === sheet && (transformation instanceof AddRowsTransformer || transformation instanceof RemoveRowsTransformer);\n      });\n\n      var _iterator5 = _createForOfIteratorHelper(relevantTransformations),\n          _step5;\n\n      try {\n        for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {\n          var transformation = _step5.value;\n\n          if (transformation instanceof AddRowsTransformer) {\n            this.addRows(col, transformation.rowsSpan, value);\n          } else if (transformation instanceof RemoveRowsTransformer) {\n            this.removeRows(col, transformation.rowsSpan, value);\n          }\n        }\n      } catch (err) {\n        _iterator5.e(err);\n      } finally {\n        _iterator5.f();\n      }\n\n      valueIndex.version = actualVersion;\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.index.clear();\n    }\n  }, {\n    key: \"addSingleCellValue\",\n    value: function addSingleCellValue(value, address) {\n      var _this = this;\n\n      this.stats.measure(StatType.BUILD_COLUMN_INDEX, function () {\n        _this.ensureRecentData(address.sheet, address.col, value);\n\n        if (typeof value === 'string') {\n          value = forceNormalizeString(value);\n        }\n\n        var valueIndex = _this.getValueIndex(address.sheet, address.col, value);\n\n        _this.addValue(valueIndex, address.row);\n      });\n    }\n  }, {\n    key: \"removeSingleValue\",\n    value: function removeSingleValue(value, address) {\n      var _this2 = this;\n\n      this.stats.measure(StatType.BUILD_COLUMN_INDEX, function () {\n        _this2.ensureRecentData(address.sheet, address.col, value);\n\n        var columnMap = _this2.getColumnMap(address.sheet, address.col);\n\n        if (typeof value === 'string') {\n          value = forceNormalizeString(value);\n        }\n\n        var valueIndex = columnMap.get(value);\n\n        if (!valueIndex) {\n          return;\n        }\n\n        var index = upperBound(valueIndex.index, address.row);\n        valueIndex.index.splice(index, 1);\n\n        if (valueIndex.index.length === 0) {\n          columnMap.delete(value);\n        }\n\n        if (columnMap.size === 0) {\n          delete _this2.index.get(address.sheet)[address.col]; // eslint-disable-line @typescript-eslint/no-non-null-assertion\n        }\n      });\n    }\n  }, {\n    key: \"addRows\",\n    value: function addRows(col, rowsSpan, value) {\n      var valueIndex = this.getValueIndex(rowsSpan.sheet, col, value);\n      this.shiftRows(valueIndex, rowsSpan.rowStart, rowsSpan.numberOfRows);\n    }\n  }, {\n    key: \"removeRows\",\n    value: function removeRows(col, rowsSpan, value) {\n      var valueIndex = this.getValueIndex(rowsSpan.sheet, col, value);\n      this.removeRowsFromValues(valueIndex, rowsSpan);\n      this.shiftRows(valueIndex, rowsSpan.rowEnd + 1, -rowsSpan.numberOfRows);\n    }\n  }, {\n    key: \"addValue\",\n    value: function addValue(valueIndex, rowNumber) {\n      var rowIndex = lowerBound(valueIndex.index, rowNumber);\n      var value = valueIndex.index[rowIndex];\n\n      if (value === rowNumber) {\n        /* do not add same row twice */\n        return;\n      }\n\n      if (rowIndex === valueIndex.index.length - 1) {\n        valueIndex.index.push(rowNumber);\n      } else {\n        valueIndex.index.splice(rowIndex + 1, 0, rowNumber);\n      }\n    }\n  }, {\n    key: \"removeRowsFromValues\",\n    value: function removeRowsFromValues(rows, rowsSpan) {\n      var start = upperBound(rows.index, rowsSpan.rowStart);\n      var end = lowerBound(rows.index, rowsSpan.rowEnd);\n\n      if (rows.index[start] <= rowsSpan.rowEnd) {\n        rows.index.splice(start, end - start + 1);\n      }\n    }\n  }, {\n    key: \"shiftRows\",\n    value: function shiftRows(rows, afterRow, numberOfRows) {\n      var index = upperBound(rows.index, afterRow);\n\n      for (var i = index; i < rows.index.length; ++i) {\n        rows.index[i] += numberOfRows;\n      }\n    }\n  }]);\n\n  return ColumnIndex;\n}();\n/*\n* If key exists returns index of key\n* Otherwise returns index of smallest element greater than key\n* assuming sorted array and no repetitions\n* */\n\nexport function upperBound(values, key) {\n  var start = 0;\n  var end = values.length - 1;\n\n  while (start <= end) {\n    var center = Math.floor((start + end) / 2);\n\n    if (key > values[center]) {\n      start = center + 1;\n    } else if (key < values[center]) {\n      end = center - 1;\n    } else {\n      return center;\n    }\n  }\n\n  return start;\n}\n/*\n* If key exists returns index of key\n* Otherwise returns index of greatest element smaller than key\n* assuming sorted array and no repetitions\n* */\n\nexport function lowerBound(values, key) {\n  var start = 0;\n  var end = values.length - 1;\n\n  while (start <= end) {\n    var center = Math.floor((start + end) / 2);\n\n    if (key > values[center]) {\n      start = center + 1;\n    } else if (key < values[center]) {\n      end = center - 1;\n    } else {\n      return center;\n    }\n  }\n\n  return end;\n}"]},"metadata":{},"sourceType":"module"}